<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout with PayPal</title>
    <style>
        body {
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
    </style>
    <script>
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                email: params.get('email') || '',
                Auth_Token: params.get('Auth_Token') || '',
                Table_Id: params.get('Table_Id') || '',
                Plan_Name: params.get('Plan_Name') || 'Default Plan',
                Cost: params.get('Cost') || '0.00',
                Client_Id: params.get('Client_Id') || ''
            };
        }
        const paymentData = getQueryParams();
    </script>
</head>
<body>
    <h1>Complete Checkout</h1>
    <p style="text-align: center;">Plan: <strong><span id="plan-name"></span></strong> - Cost: <strong>$<span id="cost"></span></strong></p>
    
    <div id="paypal-button-container"></div>
    
    <script src="https://www.paypal.com/sdk/js?client-id=" + paymentData.Client_Id></script>
    <script>
        document.getElementById("plan-name").textContent = paymentData.Plan_Name;
        document.getElementById("cost").textContent = paymentData.Cost;

        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: paymentData.Cost
                        }
                    }],
                    application_context: {
                        shipping_preference: "NO_SHIPPING" // No shipping required
                    }
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    alert("Payment Completed\n\nYour payment was successful. You can now return to the app to continue using your subscription.");
                    
                    // Send a POST request to Baserow
                    const endpoint = `https://api.baserow.io/api/database/rows/table/${paymentData.Table_Id}/?user_field_names=true`;
                    
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', endpoint);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.setRequestHeader('Authorization', `Token ${paymentData.Auth_Token}`);
                    
                    const payload = {
                        email: paymentData.email,
                        amount: details.purchase_units[0].amount.value,
                        transaction_id: details.id,
                        paid_at: new Date().toISOString(),
                        Plan_Name: paymentData.Plan_Name
                    };
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status === 200) {
                                console.log('Activation request succeeded:', xhr.responseText);
                            } else {
                                console.error('Activation request failed:', xhr.status);
                            }
                        }
                    };
                    
                    xhr.send(JSON.stringify(payload));
                });
            }
        }).render('#paypal-button-container');
    </script>
</body>
</html>

